<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magalini Medica - Clima</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: auto;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 2.2rem;
            font-weight: 600;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .broker-status {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            background: #f8fafc;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .broker-status.connected {
            background: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }

        .broker-status.disconnected {
            background: #fecaca;
            color: #991b1b;
            border-color: #ef4444;
        }

        .broker-status.connecting {
            background: #fef3c7;
            color: #92400e;
            border-color: #f59e0b;
        }

        .console-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .console-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .console-btn.active {
            background: linear-gradient(135deg, #4a90e2, #2980b9);
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }

        /* Pulsante RIMO Info */
        .rimo-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .rimo-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .rimo-btn.active {
            background: linear-gradient(135deg, #4a90e2, #2980b9);
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }

        .floors-container {
            display: grid;
            gap: 30px;
        }

        .floor-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .floor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .floor-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .floor-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #64748b;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-item.timeout {
            color: #ef4444;
            font-weight: 600;
        }

        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .room-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto auto;
            gap: 15px;
            min-height: 280px;
        }

        .room-card:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .room-card.on {
            border-color: #e5e7eb;
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            opacity: 0.7;
        }

        .room-card.off {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
        }

        .room-card.undefined {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            opacity: 0.8;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .room-name-status {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .room-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .fancoil-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .fancoil-status.on {
            background: #f3f4f6;
            color: #6b7280;
        }

        .fancoil-status.off {
            background: #dcfce7;
            color: #166534;
        }

        .fancoil-status.undefined {
            background: #fef3c7;
            color: #92400e;
        }

        .timeout-indicator {
            background: #fee2e2;
            color: #991b1b;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            border: 1px solid #fca5a5;
            margin-top: 5px;
        }

        .schedule-btn-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .schedule-btn-header:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .temperature-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .temp-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
        }

        .temp-unit {
            font-size: 0.9rem;
            color: #64748b;
        }

        .temp-unavailable {
            color: #6b7280;
            font-style: italic;
            font-size: 0.9rem;
        }

        .schedule-controls {
            display: grid;
            gap: 15px;
        }

        .date-time-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            justify-content: space-between;
        }

        .date-time-row .control-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .control-group label {
            font-size: 0.8rem;
            font-weight: 500;
            color: #64748b;
            text-align: center;
        }

        .control-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        .control-input[type="date"] {
            width: 100%;
            min-width: 0;
        }

        .control-input[type="time"], .time-select {
            width: 100%;
            min-width: 0;
            cursor: pointer;
        }

        .time-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 35px;
        }

        .control-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .action-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            padding: 4px 6px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.7rem;
            text-align: center;
            min-width: 0;
        }

        .radio-option .radio-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.65rem;
        }

        .radio-option:hover {
            background: #f8fafc;
            border-color: #667eea;
        }

        .radio-option input[type="radio"] {
            margin: 0;
        }

        .radio-option input[type="radio"]:checked + .radio-label {
            font-weight: 600;
        }

        .radio-option:has(input[type="radio"]:checked) {
            background: #f0f9ff;
            border-color: #3b82f6;
        }

        .action-row {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .action-row .control-group {
            width: 100%;
        }

        .control-group label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #64748b;
            text-align: center;
            margin-bottom: 4px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            white-space: nowrap;
            width: 100%;
            margin-top: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        /* Modal Dialog per orari settimanali */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-dialog {
            background: white;
            border-radius: 15px;
            max-width: 95vw;
            max-height: 90vh;
            width: 1000px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { 
                transform: scale(0.9) translateY(-20px);
                opacity: 0;
            }
            to { 
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 25px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 80px repeat(24, 1fr);
            gap: 2px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .hour-header {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 8px 4px;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 500;
            color: #64748b;
        }

        .day-label {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            padding: 12px 8px;
            font-weight: 600;
            font-size: 0.8rem;
            color: #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #e2e8f0;
        }

        .time-cell {
            height: 35px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 1px;
            background: #f8fafc;
        }

        .time-segment {
            background: #e2e8f0;
            transition: all 0.2s ease;
            position: relative;
        }

        .time-segment.active {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .time-segment:hover::after {
            content: attr(title);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            z-index: 10;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            justify-content: center;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        .legend-color.active {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .legend-color.inactive {
            background: #e2e8f0;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s ease;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        /* Modal Dialog RIMO Info */
        .rimo-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 2001;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .rimo-dialog.show {
            display: flex;
        }

        .rimo-content {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            animation: slideIn 0.3s ease;
        }

        .rimo-content h2 {
            color: #10b981;
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .rimo-content p {
            margin: 12px 0;
            color: #2c3e50;
            line-height: 1.6;
        }

        .rimo-content .version-info {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .rimo-content .contact-info {
            background: linear-gradient(135deg, #e8f4ff, #cfe8ff);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #3b82f6;
        }

        .rimo-close {
            margin-top: 25px;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .rimo-close:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .rimo-close:active {
            transform: translateY(1px);
        }

        /* Console integrata */
        .console-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 600px;
            max-width: 90vw;
            height: 400px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .console-container.show {
            display: flex;
        }

        .console-header {
            background: rgba(50, 50, 50, 0.9);
            padding: 12px 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        .console-title {
            color: #27ae60;
            font-weight: 600;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .console-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .console-control-btn {
            background: none;
            border: none;
            color: #bbb;
            cursor: pointer;
            font-size: 1.2em;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .console-control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .console-clear {
            font-size: 0.8em;
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            padding: 4px 10px;
            border: 1px solid #e74c3c;
            border-radius: 4px;
        }

        .console-clear:hover {
            background: rgba(231, 76, 60, 0.3);
        }

        .console-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
            line-height: 1.5;
        }

        .console-log {
            margin-bottom: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            word-wrap: break-word;
        }

        .console-log.info {
            color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .console-log.success {
            color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .console-log.warning {
            color: #f39c12;
            background: rgba(243, 156, 18, 0.1);
        }

        .console-log.error {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .console-log.mqtt {
            color: #9b59b6;
            background: rgba(155, 89, 182, 0.1);
            border-left: 3px solid #9b59b6;
        }

        .console-timestamp {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            .rooms-grid {
                grid-template-columns: 1fr;
            }
            
            .date-time-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .date-time-row .control-group {
                width: 100%;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }

            .room-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .room-name-status {
                width: 100%;
                justify-content: space-between;
            }

            .schedule-btn-header {
                margin-left: 0;
                align-self: flex-end;
            }

            .modal-dialog {
                width: 95vw;
                margin: 10px;
            }

            .schedule-grid {
                grid-template-columns: 60px repeat(24, 1fr);
            }

            .hour-header {
                font-size: 0.6rem;
                padding: 6px 2px;
            }

            .day-label {
                font-size: 0.7rem;
                padding: 8px 4px;
            }

            .connection-status {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .rimo-content {
                padding: 20px;
                margin: 20px;
            }

            .rimo-content h2 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 400px) {
            .action-selector {
                gap: 3px;
            }
            
            .radio-option {
                padding: 3px 4px;
                font-size: 0.65rem;
                gap: 2px;
            }
            
            .radio-option .radio-label {
                font-size: 0.6rem;
            }
            
            .btn {
                padding: 5px 10px;
                font-size: 0.7rem;
            }

            .room-card {
                padding: 15px;
            }

            .control-group label {
                font-size: 0.7rem;
                margin-bottom: 3px;
            }

            .schedule-grid {
                grid-template-columns: 50px repeat(12, 1fr);
            }

            .hour-header:nth-child(odd) {
                display: none;
            }

            .time-cell:nth-child(odd) {
                display: none;
            }
        }

        @media (max-width: 1200px) and (min-width: 401px) {
            .radio-option {
                padding: 3px 5px;
                font-size: 0.68rem;
            }
            
            .radio-option .radio-label {
                font-size: 0.62rem;
            }
        }
    </style>
    
    <!-- Paho MQTT JavaScript Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üå°Ô∏è Magalini Medica - Clima</h1>
            <div class="connection-status">
                <div class="broker-status disconnected" id="brokerStatus">
                    <strong>Stato MQTT:</strong> <span id="brokerStatusText">Disconnesso</span>
                </div>
                <button class="console-btn" id="consoleBtn">
                    üñ•Ô∏è Console
                </button>
                <button class="rimo-btn" onclick="showRimoInfo()">
                    üë®‚Äçüíº RIMO
                </button>
            </div>
        </div>

        <div class="floors-container">
            <div class="floor-section">
                <div class="floor-header">
                    <div class="floor-title">üè¢ Piano Terra</div>
                    <div class="floor-stats">
                        <div class="stat-item">
                            <span>Locali:</span>
                            <strong id="ptTotal">0</strong>
                        </div>
                        <div class="stat-item">
                            <span>Attivi:</span>
                            <strong id="ptActive">0</strong>
                        </div>
                        <div class="stat-item timeout" id="ptTimeout" style="display: none;">
                            <span>‚ö†Ô∏è Timeout:</span>
                            <strong id="ptTimeoutCount">0</strong>
                        </div>
                    </div>
                </div>
                <div class="rooms-grid" id="pianoTerraRooms"></div>
            </div>

            <div class="floor-section">
                <div class="floor-header">
                    <div class="floor-title">üèòÔ∏è Piano Interrato</div>
                    <div class="floor-stats">
                        <div class="stat-item">
                            <span>Locali:</span>
                            <strong id="piTotal">0</strong>
                        </div>
                        <div class="stat-item">
                            <span>Attivi:</span>
                            <strong id="piActive">0</strong>
                        </div>
                        <div class="stat-item timeout" id="piTimeout" style="display: none;">
                            <span>‚ö†Ô∏è Timeout:</span>
                            <strong id="piTimeoutCount">0</strong>
                        </div>
                    </div>
                </div>
                <div class="rooms-grid" id="pianoInterratoRooms"></div>
            </div>

            <div class="floor-section">
                <div class="floor-header">
                    <div class="floor-title">üèãÔ∏è Palestra</div>
                    <div class="floor-stats">
                        <div class="stat-item">
                            <span>Locali:</span>
                            <strong id="paTotal">0</strong>
                        </div>
                        <div class="stat-item">
                            <span>Attivi:</span>
                            <strong id="paActive">0</strong>
                        </div>
                        <div class="stat-item timeout" id="paTimeout" style="display: none;">
                            <span>‚ö†Ô∏è Timeout:</span>
                            <strong id="paTimeoutCount">0</strong>
                        </div>
                    </div>
                </div>
                <div class="rooms-grid" id="palestraRooms"></div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- Console integrata -->
    <div class="console-container" id="consoleContainer">
        <div class="console-header" id="consoleHeader">
            <div class="console-title">
                <span>üñ•Ô∏è</span>
                <span>Console MQTT Magalini</span>
            </div>
            <div class="console-controls">
                <button class="console-control-btn console-clear" id="consoleClear">üóëÔ∏è Pulisci</button>
                <button class="console-control-btn" id="consoleMinimize">‚àí</button>
                <button class="console-control-btn" id="consoleClose">√ó</button>
            </div>
        </div>
        <div class="console-body" id="consoleBody"></div>
    </div>

    <!-- Modal Dialog per Orari Settimanali -->
    <div class="modal-overlay" id="scheduleModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <div class="modal-title">
                    <span>üìÖ</span>
                    <span id="modalRoomName">Orari Settimanali</span>
                </div>
                <button class="modal-close" onclick="closeScheduleModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="scheduleContent">
                    <!-- Il contenuto verr√† generato dinamicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeScheduleModal()">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- RIMO Info Dialog -->
    <div class="rimo-dialog" id="rimoDialog">
        <div class="rimo-content">
            <h2>üë®‚Äçüíº Riccardo Marin (RIMO)</h2>
            
            <div class="version-info">
                <p><strong>üå°Ô∏è Magalini Medica - Sistema Clima</strong></p>
                <p><strong>Versione:</strong> 2.1 Web MQTT - Sistema Unificato</p>
                <p><strong>Data Rilascio:</strong> 7 Luglio 2025</p>
                <p><strong>Tecnologia:</strong> MQTT WebSocket + Dashboard Responsive</p>
            </div>

            <div class="contact-info">
                <p><strong>üë®‚Äçüíª Sviluppato da:</strong> Riccardo Marin (RIMO)</p>
                <p><strong>üì± Telefono:</strong> +39 3483539416</p>
                <p><strong>üìß Email:</strong> riccardo.marin@rimo64.net</p>
            </div>

            <p><strong>üîß Sistema:</strong> Controllo climatizzazione fancoil per struttura medica</p>
            <p><strong>üì° Protocollo:</strong> MQTT over WebSocket Secure (broker.emqx.io)</p>
            <p><strong>‚è∞ Features:</strong> Programmazione orari, monitoraggio temperatura, gestione timeout</p>
            <p><strong>üìä Architettura:</strong> Topic unificati con timeout detection e console integrata</p>
            
            <button class="rimo-close" onclick="closeRimoInfo()">Chiudi</button>
        </div>
    </div>

    <script>
        // Configurazione MQTT
        const MQTT_CONFIG = {
            host: 'broker.emqx.io',
            port: 8084,
            clientId: 'magalini_medica_dashboard_' + Math.random().toString(16).substr(2, 8),
            connected: false,
            client: null
        };

        // Configurazione timeout (90 secondi)
        const TIMEOUT_MS = 90000;

        // Sistema Console Integrata
        let consoleVisible = false;
        let consoleBody;
        let consoleContainer;
        let consoleBtn;
        
        // Topic MQTT unificato
        const TOPICS = {
            SCHEDULE_SET: 'magalini/fancoil/schedule/set',
            SYSTEM_COMMAND: 'magalini/system/command',
            SYSTEM_STATUS: 'magalini/system/status',
            WEEKLY_SCHEDULE: 'magalini/fancoil/weekly_schedule/',
            WEEKLY_REQUEST: 'magalini/fancoil/weekly_schedule/request'
        };

        // Configurazione rooms con stato iniziale undefined
        let rooms = {
            pianoTerra: [
                { id: 'ufficio', name: 'Ufficio', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'atrio', name: 'Atrio', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'ambulatorio01', name: 'Ambulatorio 01', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'ambulatori0204', name: 'Ambulatori 02-04', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'ambulatorio05', name: 'Ambulatorio 05', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'ambulatorio06', name: 'Ambulatorio 06', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'ambulatorio07', name: 'Ambulatorio 07', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'ambulatorio08', name: 'Ambulatorio 08', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'ambulatorio09', name: 'Ambulatorio 09', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null }
            ],
            pianoInterrato: [
                { id: 'ambulatorio11', name: 'Ambulatorio 11', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'ambulatorio12', name: 'Ambulatorio 12', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'ambulatorio13', name: 'Ambulatorio 13', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'ambulatorio14', name: 'Ambulatorio 14', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null }
            ],
            palestra: [
                { id: 'palestra', name: 'Palestra', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'sala_attesa', name: 'Sala Attesa', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'corridoio', name: 'Corridoio', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'bagno_femminile', name: 'Bagno Femminile', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'bagno_maschile', name: 'Bagno Maschile', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null },
                { id: 'risonanza', name: 'Risonanza', status: 'undefined', temperature: null, mode: 'undefined', lastUpdate: null }
            ],
        };

        // Funzioni RIMO Info Dialog
        function showRimoInfo() {
            document.getElementById('rimoDialog').classList.add('show');
        }

        function closeRimoInfo() {
            document.getElementById('rimoDialog').classList.remove('show');
        }

        // Funzione per aggiungere log alla console
        function addConsoleLog(type, message, isRaw = false) {
            if (!consoleBody) return;
            
            const timestamp = new Date().toLocaleTimeString('it-IT');
            const logEntry = document.createElement('div');
            logEntry.className = `console-log ${type}`;
            
            if (isRaw) {
                logEntry.innerHTML = `<span class="console-timestamp">${timestamp}</span>${message}`;
            } else {
                logEntry.innerHTML = `<span class="console-timestamp">${timestamp}</span>${escapeHtml(message)}`;
            }
            
            consoleBody.appendChild(logEntry);
            consoleBody.scrollTop = consoleBody.scrollHeight;
            
            while (consoleBody.children.length > 500) {
                consoleBody.removeChild(consoleBody.firstChild);
            }
        }
        
        // Escape HTML per sicurezza
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Override console.log per catturare tutti i log
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    return JSON.stringify(arg, null, 2);
                }
                return String(arg);
            }).join(' ');
            
            let type = 'info';
            if (message.includes('‚úÖ')) type = 'success';
            else if (message.includes('‚ùå')) type = 'error';
            else if (message.includes('‚ö†Ô∏è')) type = 'warning';
            else if (message.includes('üì•') || message.includes('üì§') || message.includes('MQTT')) type = 'mqtt';
            
            addConsoleLog(type, message);
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            const message = args.join(' ');
            addConsoleLog('error', message);
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            const message = args.join(' ');
            addConsoleLog('warning', message);
        };

        // Genera opzioni per gli orari (ogni 15 minuti)
        function generateTimeOptions() {
            let options = '';
            for (let hour = 0; hour < 24; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    const hourStr = hour.toString().padStart(2, '0');
                    const minuteStr = minute.toString().padStart(2, '0');
                    const timeValue = `${hourStr}:${minuteStr}`;
                    options += `<option value="${timeValue}">${timeValue}</option>`;
                }
            }
            return options;
        }

        // Controllo periodico timeout
        function checkTimeouts() {
            const now = Date.now();
            let hasChanges = false;
            
            for (const floor in rooms) {
                rooms[floor].forEach(room => {
                    const oldStatus = room.status;
                    
                    if (!room.lastUpdate || (now - room.lastUpdate) > TIMEOUT_MS) {
                        if (room.status !== 'undefined') {
                            room.status = 'undefined';
                            room.mode = 'undefined';
                            hasChanges = true;
                            console.log(`‚ö†Ô∏è TIMEOUT: ${room.name} - Nessun aggiornamento da ${room.lastUpdate ? Math.round((now - room.lastUpdate) / 1000) : 'mai'} secondi`);
                        }
                    }
                });
            }
            
            if (hasChanges) {
                updateAllRoomCards();
                updateStatistics();
            }
        }

        // Avvia controllo timeout ogni 30 secondi
        setInterval(checkTimeouts, 30000);

        // Inizializzazione dashboard
        function initializeDashboard() {
            console.log('üöÄ Inizializzazione Magalini Medica - Clima...');
            addConsoleLog('success', 'üöÄ Console MQTT Magalini inizializzata');
            addConsoleLog('info', 'üì° In attesa di connessione a broker.emqx.io...');
            addConsoleLog('info', 'üîß Configurazione: broker.emqx.io:8084 (WebSocket Sicuro SSL/TLS)');
            addConsoleLog('info', `‚è±Ô∏è Timeout dispositivi configurato: ${TIMEOUT_MS/1000} secondi`);
            renderRooms();
            connectMQTT();
            updateStatistics();
            
            setTimeout(checkTimeouts, 1000);
        }

        // Connessione MQTT
        function connectMQTT() {
            updateMQTTStatus('connecting', 'Connessione in corso...');
            
            try {
                MQTT_CONFIG.client = new Paho.MQTT.Client(
                    MQTT_CONFIG.host, 
                    MQTT_CONFIG.port, 
                    MQTT_CONFIG.clientId
                );
                
                MQTT_CONFIG.client.onConnectionLost = function(responseObject) {
                    if (responseObject.errorCode !== 0) {
                        console.log("‚ùå Connessione MQTT persa:", responseObject.errorMessage);
                        MQTT_CONFIG.connected = false;
                        updateMQTTStatus('disconnected', 'Connessione persa: ' + responseObject.errorMessage);
                        
                        setTimeout(() => {
                            if (!MQTT_CONFIG.connected) {
                                connectMQTT();
                            }
                        }, 5000);
                    }
                };
                
                MQTT_CONFIG.client.onMessageArrived = function(message) {
                	console.log("üì® MQTT RAW - Topic:", message.destinationName, "- Payload length:", message.payloadString.length);
                    console.log("üì• Messaggio MQTT ricevuto:", message.destinationName, message.payloadString);
                    handleMQTTMessage(message.destinationName, message.payloadString);
                };

MQTT_CONFIG.client.onMessageArrived = function(message) {
    console.log("üì• Messaggio MQTT ricevuto:", message.destinationName, message.payloadString);
    handleMQTTMessage(message.destinationName, message.payloadString);
};
                
                const connectOptions = {
                    onSuccess: function() {
                        console.log("‚úÖ MQTT connesso a", MQTT_CONFIG.host);
                        MQTT_CONFIG.connected = true;
                        updateMQTTStatus('connected', 'Connesso a ' + MQTT_CONFIG.host);
                        subscribeToTopics();
                    },
                    onFailure: function(message) {
                        console.log("‚ùå Connessione MQTT fallita:", message.errorMessage);
                        MQTT_CONFIG.connected = false;
                        updateMQTTStatus('disconnected', 'Errore: ' + message.errorMessage);
                        setTimeout(connectMQTT, 10000);
                    },
                    timeout: 10,
                    keepAliveInterval: 60,
                    cleanSession: true,
                    useSSL: true
                };
                
                MQTT_CONFIG.client.connect(connectOptions);
                
            } catch (error) {
                console.error("‚ùå Errore inizializzazione MQTT:", error);
                updateMQTTStatus('disconnected', 'Errore inizializzazione');
            }
        }

        // Sottoscrivi al topic unificato
        function subscribeToTopics() {
            const topics = [
                TOPICS.SYSTEM_STATUS,
                TOPICS.WEEKLY_SCHEDULE + '+',
                TOPICS.SYSTEM_COMMAND
            ];

            topics.forEach(topic => {
                try {
                    MQTT_CONFIG.client.subscribe(topic);
                    console.log("‚úÖ Sottoscritto a:", topic);
                } catch (error) {
                    console.error("‚ùå Errore sottoscrizione a", topic, error);
                }
            });
        }

        // Gestisce messaggi MQTT dal topic unificato
		function handleMQTTMessage(topic, payload) {
            try {
                console.log('=====================================');
                console.log('üì• NUOVO MESSAGGIO MQTT');
                console.log('üìç Topic:', topic);
                console.log('üìÑ Payload:', payload);
                console.log('=====================================');

                let message;
                let isJson = true;

                // Prova a parsare come JSON
                try {
                    message = JSON.parse(payload);
                } catch (parseError) {
                    // Se non √® JSON, usa il payload come stringa
                    console.log("‚ÑπÔ∏è Payload non √® JSON, processando come testo");
                    message = payload;
                    isJson = false;
                }

                // Processa in base al topic
                if (topic === TOPICS.SYSTEM_STATUS) {
                    if (isJson) {
                        handleSystemStatus(message);
                    } else {
                        console.error("‚ùå System status deve essere JSON");
                    }
                } else if (topic === TOPICS.WEEKLY_REQUEST) {
                    // Ignora l'echo della richiesta
                    console.log("üì§ Echo richiesta orari ignorato (normale comportamento MQTT)");
                } else if (topic.includes('/weekly_schedule/') && !topic.endsWith('/request')) {
                    // Processa solo le risposte, non le richieste
                    const roomId = topic.split('/').pop();
                    if (isJson) {
                        handleWeeklySchedule(roomId, message);
                    } else {
                        console.error("‚ùå Weekly schedule deve essere JSON");
                    }
                } else if (topic === TOPICS.SYSTEM_COMMAND) {
                    console.log("üìä Comando sistema:", message);
                } else {
                    console.log("‚ö†Ô∏è Topic non gestito:", topic);
                }

            } catch (error) {
                console.error("‚ùå Errore handleMQTTMessage:", error);
                console.error("Topic:", topic);
                console.error("Payload:", payload);
                error.printStackTrace ? error.printStackTrace() : console.error(error.stack);
            }
        }

        // Gestisce il messaggio di stato unificato
        function handleSystemStatus(data) {
            try {
                console.log("üìä ===== AGGIORNAMENTO STATO SISTEMA =====");
                console.log("üè† Timestamp sistema:", data.timestamp);
                console.log("üìã Floors ricevuti:", Object.keys(data.floors || {}));
                
                if (!data.floors) {
                    console.error("‚ùå Dati floors non trovati nel messaggio");
                    return;
                }
                
                const now = Date.now();
                let updatedRooms = 0;
                let timeoutRooms = 0;
                
                for (const [floorName, floorData] of Object.entries(data.floors)) {
                    console.log(`üè¢ Processando piano: ${floorName}`);
                    
                    const floorKey = mapFloorName(floorName);
                    if (!floorKey || !rooms[floorKey]) {
                        console.warn(`‚ö†Ô∏è Piano ${floorName} non riconosciuto`);
                        continue;
                    }
                    
                    for (const [roomId, roomData] of Object.entries(floorData)) {
                        const room = rooms[floorKey].find(r => r.id === roomId);
                        
                        if (!room) {
                            console.warn(`‚ö†Ô∏è Stanza ${roomId} non trovata in ${floorKey}`);
                            continue;
                        }
                        
                        const lastUpdate = roomData.lastUpdate || 0;
                        const isTimeout = (now - lastUpdate) > TIMEOUT_MS;
                        
                        const oldStatus = room.status;
                        room.lastUpdate = lastUpdate;
                        
                        if (isTimeout) {
                            room.status = 'undefined';
                            room.mode = 'undefined';
                            room.temperature = null;
                            timeoutRooms++;
                            console.log(`‚ö†Ô∏è ${room.name}: TIMEOUT (${Math.round((now - lastUpdate) / 1000)}s ago)`);
                        } else {
                            room.status = roomData.status || 'undefined';
                            room.mode = roomData.mode || 'undefined';
                            
                            if (roomData.temperature !== undefined && roomData.temperature !== null) {
                                room.temperature = parseFloat(roomData.temperature);
                            }
                            
                            updatedRooms++;
                            console.log(`‚úÖ ${room.name}: ${room.status.toUpperCase()} (${room.mode}) ${room.temperature ? room.temperature.toFixed(1) + '¬∞C' : ''}`);
                        }
                        
                        if (oldStatus !== room.status) {
                            updateRoomCard(roomId, room);
                        }
                    }
                }
                
                console.log(`üìä Aggiornamento completato: ${updatedRooms} stanze attive, ${timeoutRooms} in timeout`);
                updateStatistics();
                console.log("üìä ==========================================");
                
            } catch (error) {
                console.error("‚ùå Errore handleSystemStatus:", error);
            }
        }

        // Mappa nomi piani dal payload ai nomi locali
        function mapFloorName(floorName) {
            const mapping = {
                'pianoTerra': 'pianoTerra',
                'pianoInterrato': 'pianoInterrato', 
                'palestra': 'palestra'
            };
            return mapping[floorName] || null;
        }

        // Gestisce gli orari settimanali
        function handleWeeklySchedule(roomId, scheduleData) {
            try {
                console.log("üìÖ ===== DIAGNOSTICA ORARI SETTIMANALI =====");
                console.log("üè† Room ID:", roomId);
                console.log("üìä Tipo dati ricevuti:", typeof scheduleData);
                console.log("üìã Dati grezzi:", scheduleData);
                
                const room = findRoomById(roomId);
                const roomName = room ? room.name : roomId;
                
                let processedSchedule = null;
                
                if (scheduleData && scheduleData.schedule) {
                    console.log("‚úÖ Trovata propriet√† 'schedule':", scheduleData.schedule);
                    processedSchedule = convertScheduleFormat(scheduleData.schedule);
                } else if (scheduleData && typeof scheduleData === 'object') {
                    console.log("üîç Tentativo conversione diretta dell'oggetto");
                    processedSchedule = convertScheduleFormat(scheduleData);
                }
                
                if (processedSchedule) {
                    console.log("‚úÖ Schedule processato correttamente:", processedSchedule);
                    showScheduleModal(roomName, processedSchedule);
                    showNotification(`üìÖ Orari ricevuti per ${roomName}`, 'success', 4000);
                } else {
                    console.error("‚ùå Impossibile processare i dati del schedule");
                    showNotification('‚ùå Formato dati orari non riconosciuto', 'error');
                }
                
                console.log("üìÖ ============================================");
                
            } catch (error) {
                console.error("‚ùå Errore handleWeeklySchedule:", error);
                showNotification('‚ùå Errore visualizzazione orari', 'error');
            }
        }

        // Converte il formato schedule dall'oggetto all'array
        function convertScheduleFormat(scheduleObj) {
            try {
                console.log("üîÑ Conversione formato schedule...");
                
                const dayMapping = {
                    'lunedi': 0,
                    'martedi': 1, 
                    'mercoledi': 2,
                    'giovedi': 3,
                    'venerdi': 4,
                    'sabato': 5,
                    'domenica': 6
                };
                
                const weekSchedule = new Array(7);
                
                for (let i = 0; i < 7; i++) {
                    weekSchedule[i] = new Array(24).fill(0);
                }
                
                for (const [dayName, dayData] of Object.entries(scheduleObj)) {
                    const dayIndex = dayMapping[dayName.toLowerCase()];
                    
                    if (dayIndex !== undefined && typeof dayData === 'object') {
                        console.log(`üìÖ Processando ${dayName} (indice ${dayIndex}):`, dayData);
                        
                        for (let hour = 0; hour < 24; hour++) {
                            const hourValue = dayData[hour.toString()];
                            if (hourValue !== undefined) {
                                weekSchedule[dayIndex][hour] = parseInt(hourValue, 10) || 0;
                            }
                        }
                        
                        console.log(`‚úÖ ${dayName} convertito:`, weekSchedule[dayIndex]);
                    } else {
                        console.warn(`‚ùå Giorno ${dayName} non riconosciuto o dati non validi`);
                    }
                }
                
                console.log("‚úÖ Schedule finale convertito:", weekSchedule);
                return weekSchedule;
                
            } catch (error) {
                console.error("‚ùå Errore convertScheduleFormat:", error);
                return null;
            }
        }

        // Mostra la finestra di dialogo degli orari
        function showScheduleModal(roomName, scheduleData) {
            try {
                document.getElementById('modalRoomName').textContent = `Orari Settimanali - ${roomName}`;
                const scheduleContent = generateScheduleHTML(scheduleData);
                document.getElementById('scheduleContent').innerHTML = scheduleContent;
                document.getElementById('scheduleModal').classList.add('show');
            } catch (error) {
                console.error("‚ùå Errore showScheduleModal:", error);
            }
        }

// Genera HTML per la visualizzazione degli orari
function generateScheduleHTML(scheduleData) {
    try {
        const daysOfWeek = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato', 'Domenica'];
        
        // Ottieni il giorno corrente (0 = Domenica, 1 = Luned√¨, ..., 6 = Sabato)
        const today = new Date().getDay();
        // Converti al formato array (0 = Luned√¨, 1 = Marted√¨, ..., 6 = Domenica)
        const todayIndex = today === 0 ? 6 : today - 1;
        
        // Riorganizza l'array dei giorni partendo da oggi
        const reorderedDays = [];
        const reorderedIndices = [];
        
        for (let i = 0; i < 7; i++) {
            const dayIndex = (todayIndex + i) % 7;
            reorderedDays.push(daysOfWeek[dayIndex]);
            reorderedIndices.push(dayIndex);
        }
        
        console.log(`üìÖ Oggi √® ${daysOfWeek[todayIndex]}, riordinando giorni:`, reorderedDays);
        
        let html = `
            <div class="schedule-grid">
                <div class="day-label">Giorno</div>
        `;
        
        for (let hour = 0; hour < 24; hour++) {
            html += `<div class="hour-header">${hour.toString().padStart(2, '0')}</div>`;
        }
        
        // Usa l'ordine riorganizzato dei giorni
        for (let displayIndex = 0; displayIndex < 7; displayIndex++) {
            const actualDayIndex = reorderedIndices[displayIndex];
            const dayName = reorderedDays[displayIndex];
            
            // Aggiungi indicatore per il giorno corrente
            const isToday = displayIndex === 0;
            const dayLabel = isToday ? `üìç ${dayName} (OGGI)` : dayName;
            
            html += `<div class="day-label" ${isToday ? 'style="background: linear-gradient(135deg, #10b981, #059669); color: white; font-weight: 700;"' : ''}>${dayLabel}</div>`;
            
            for (let hour = 0; hour < 24; hour++) {
                html += `<div class="time-cell">`;
                
                for (let segment = 0; segment < 8; segment++) {
                    const isActive = isTimeSegmentActive(scheduleData, actualDayIndex, hour, segment);
                    
                    const segmentMinutes = [
                        { start: 0, end: 7 },   
                        { start: 8, end: 14 },  
                        { start: 15, end: 22 }, 
                        { start: 23, end: 29 }, 
                        { start: 30, end: 37 }, 
                        { start: 38, end: 44 }, 
                        { start: 45, end: 52 }, 
                        { start: 53, end: 59 }  
                    ];
                    
                    const segInfo = segmentMinutes[segment];
                    const timeRange = `${hour.toString().padStart(2, '0')}:${segInfo.start.toString().padStart(2, '0')}-${hour.toString().padStart(2, '0')}:${segInfo.end.toString().padStart(2, '0')}`;
                    
                    html += `<div class="time-segment ${isActive ? 'active' : ''}" 
                             title="${dayName} ${timeRange}${isActive ? ' (ATTIVO)' : ' (spento)'}"></div>`;
                }
                
                html += `</div>`;
            }
        }
        
        html += `
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color active"></div>
                    <span>Fancoil Attivo</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color inactive"></div>
                    <span>Fancoil Spento</span>
                </div>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 0.85rem; color: #0369a1;">
                <strong>üí° Come leggere:</strong> Ogni ora √® divisa in 8 segmenti di ~7-8 minuti. 
                Passa il mouse sui segmenti per vedere l'orario esatto. Il giorno corrente √® evidenziato in verde.
            </div>
        `;
        
        return html;
        
    } catch (error) {
        console.error("‚ùå Errore generateScheduleHTML:", error);
        return '<p>Errore nella visualizzazione degli orari</p>';
    }
}

        // Verifica se un segmento di tempo √® attivo
        function isTimeSegmentActive(scheduleData, day, hour, segment) {
            try {
                if (!scheduleData || !Array.isArray(scheduleData) || scheduleData.length !== 7) {
                    console.warn("‚ùå Formato dati schedule non valido - non √® array di 7 giorni:", scheduleData);
                    return false;
                }
                
                const daySchedule = scheduleData[day];
                if (!Array.isArray(daySchedule) || daySchedule.length !== 24) {
                    console.warn(`‚ùå Dati giorno ${day} non validi - non √® array di 24 ore:`, daySchedule);
                    return false;
                }
                
                const hourByte = daySchedule[hour];
                if (typeof hourByte !== 'number') {
                    console.warn(`‚ùå Byte ora ${hour} non √® un numero:`, hourByte);
                    return false;
                }
                
                const bitMask = 1 << segment;
                const isActive = (hourByte & bitMask) !== 0;
                
                if (hourByte !== 0) {
                    console.log(`üîß Ora attiva ${hour}: byte=${hourByte}, segment=${segment}, bitMask=${bitMask}, isActive=${isActive}`);
                }
                
                return isActive;
                
            } catch (error) {
                console.error("‚ùå Errore isTimeSegmentActive:", error);
                return false;
            }
        }

        // Chiude la finestra di dialogo degli orari
        function closeScheduleModal() {
            try {
                document.getElementById('scheduleModal').classList.remove('show');
            } catch (error) {
                console.error("‚ùå Errore closeScheduleModal:", error);
            }
        }

        // Aggiorna stato MQTT nella UI
        function updateMQTTStatus(status, text) {
            try {
                const brokerStatusElement = document.getElementById('brokerStatusText');
                const brokerElement = document.getElementById('brokerStatus');
                
                if (!brokerStatusElement || !brokerElement) {
                    console.error('Elementi broker status non trovati');
                    return;
                }
                
                brokerElement.className = 'broker-status ' + status;
                brokerStatusElement.textContent = text;
                
                if (status === 'connected') {
                    brokerStatusElement.textContent += ' - ' + new Date().toLocaleTimeString();
                }
            } catch (error) {
                console.error('Errore updateMQTTStatus:', error);
            }
        }

        // Invia programmazione via MQTT
        function sendSchedule(roomId) {
            if (!MQTT_CONFIG.connected || !MQTT_CONFIG.client) {
                showNotification('‚ùå MQTT non connesso', 'error');
                return;
            }

            try {
                const date = document.getElementById(`date_${roomId}`).value;
                const startTime = document.getElementById(`startTime_${roomId}`).value;
                const endTime = document.getElementById(`endTime_${roomId}`).value;
                
                const missingFields = [];
                if (!date || date.trim() === '') missingFields.push('Data');
                if (!startTime || startTime.trim() === '') missingFields.push('Ora Inizio');
                if (!endTime || endTime.trim() === '') missingFields.push('Ora Fine');
                
                if (missingFields.length > 0) {
                    const roomName = getRoomName(roomId);
                    const missingText = missingFields.join(', ');
                    showNotification(
                        `‚ùå ${roomName}: Compila ${missingText} prima di inviare!`, 
                        'warning', 
                        5000
                    );
                    highlightMissingFields(roomId, missingFields);
                    return;
                }
                
                if (!validateTimeRange(startTime, endTime)) {
                    const roomName = getRoomName(roomId);
                    showNotification(
                        `‚ùå ${roomName}: L'ora di fine deve essere maggiore dell'ora di inizio!`, 
                        'warning', 
                        5000
                    );
                    highlightTimeFields(roomId);
                    return;
                }
                
                const actionRadios = document.querySelectorAll(`input[name="action_${roomId}"]`);
                let selectedAction = 'on';
                for (const radio of actionRadios) {
                    if (radio.checked) {
                        selectedAction = radio.value;
                        break;
                    }
                }
                
                const dateObj = new Date(date);
                const schedule = {
                    roomId: roomId,
                    date: { 
                        day: dateObj.getDate(), 
                        month: dateObj.getMonth() + 1, 
                        year: dateObj.getFullYear() 
                    },
                    startTime: startTime,
                    endTime: endTime,
                    action: selectedAction,
                    timestamp: Date.now()
                };
                
                const message = new Paho.MQTT.Message(JSON.stringify(schedule));
                message.destinationName = TOPICS.SCHEDULE_SET;
                message.qos = 0;
                message.retained = false;
                MQTT_CONFIG.client.send(message);
                
                console.log('üì§ Programmazione inviata via MQTT:', schedule);
                
                const room = findRoomById(roomId);
                const actionText = selectedAction === 'on' ? 'ACCENSIONE' : 'SPEGNIMENTO';
                showNotification(
                    `‚úÖ ${actionText} programmato per ${room?.name || roomId}: ${schedule.date.day}/${schedule.date.month}/${schedule.date.year} ${startTime}-${endTime}`, 
                    'success',
                    6000
                );
                
                resetRoomForm(roomId);
                
            } catch (error) {
                console.error('Errore sendSchedule:', error);
                showNotification('‚ùå Errore durante l\'invio', 'error');
            }
        }

        // Validazione funzioni di supporto
        function validateTimeRange(startTime, endTime) {
            try {
                const startMinutes = timeToMinutes(startTime);
                const endMinutes = timeToMinutes(endTime);
                return endMinutes > startMinutes;
            } catch (error) {
                console.error('Errore validateTimeRange:', error);
                return false;
            }
        }

        function timeToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function highlightTimeFields(roomId) {
            try {
                const startTimeInput = document.getElementById(`startTime_${roomId}`);
                const endTimeInput = document.getElementById(`endTime_${roomId}`);
                
                [startTimeInput, endTimeInput].forEach(input => {
                    if (input) {
                        input.style.borderColor = '#ef4444';
                        input.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.2)';
                        
                        setTimeout(() => {
                            input.style.borderColor = '#d1d5db';
                            input.style.boxShadow = 'none';
                        }, 3000);
                    }
                });
            } catch (error) {
                console.error('Errore highlightTimeFields:', error);
            }
        }

        function validateRoomInputs(roomId) {
            try {
                const dateInput = document.getElementById(`date_${roomId}`);
                const startTimeInput = document.getElementById(`startTime_${roomId}`);
                const endTimeInput = document.getElementById(`endTime_${roomId}`);
                const submitButton = document.querySelector(`#room_${roomId} .btn-primary`);
                
                if (!dateInput || !startTimeInput || !endTimeInput || !submitButton) {
                    return false;
                }
                
                const hasDate = dateInput.value && dateInput.value.trim() !== '';
                const hasStartTime = startTimeInput.value && startTimeInput.value.trim() !== '';
                const hasEndTime = endTimeInput.value && endTimeInput.value.trim() !== '';
                
                let timeRangeValid = true;
                if (hasStartTime && hasEndTime) {
                    timeRangeValid = validateTimeRange(startTimeInput.value, endTimeInput.value);
                }
                
                const isValid = hasDate && hasStartTime && hasEndTime && timeRangeValid;
                
                submitButton.disabled = false;
                if (isValid) {
                    submitButton.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    submitButton.style.opacity = '1';
                } else {
                    submitButton.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    submitButton.style.opacity = '0.8';
                }
                
                if (hasStartTime && hasEndTime && !timeRangeValid) {
                    startTimeInput.style.borderColor = '#ef4444';
                    endTimeInput.style.borderColor = '#ef4444';
                } else {
                    startTimeInput.style.borderColor = '#d1d5db';
                    endTimeInput.style.borderColor = '#d1d5db';
                }
                
                return isValid;
                
            } catch (error) {
                console.error('Errore validateRoomInputs:', error);
                return false;
            }
        }

        function setupInputListeners(roomId) {
            try {
                const dateInput = document.getElementById(`date_${roomId}`);
                const startTimeInput = document.getElementById(`startTime_${roomId}`);
                const endTimeInput = document.getElementById(`endTime_${roomId}`);
                
                if (dateInput) {
                    dateInput.addEventListener('change', () => validateRoomInputs(roomId));
                    dateInput.addEventListener('input', () => validateRoomInputs(roomId));
                }
                
                if (startTimeInput) {
                    startTimeInput.addEventListener('change', () => {
                        validateRoomInputs(roomId);
                        checkTimeValidation(roomId);
                    });
                }
                
                if (endTimeInput) {
                    endTimeInput.addEventListener('change', () => {
                        validateRoomInputs(roomId);
                        checkTimeValidation(roomId);
                    });
                }
                
                setTimeout(() => validateRoomInputs(roomId), 100);
                
            } catch (error) {
                console.error('Errore setupInputListeners:', error);
            }
        }

        function checkTimeValidation(roomId) {
            try {
                const startTimeInput = document.getElementById(`startTime_${roomId}`);
                const endTimeInput = document.getElementById(`endTime_${roomId}`);
                
                if (!startTimeInput || !endTimeInput) return;
                
                const startTime = startTimeInput.value;
                const endTime = endTimeInput.value;
                
                if (startTime && endTime) {
                    const isValid = validateTimeRange(startTime, endTime);
                    
                    if (!isValid) {
                        const roomName = getRoomName(roomId);
                        showNotification(
                            `‚ö†Ô∏è ${roomName}: Ora fine deve essere maggiore di ora inizio`, 
                            'warning', 
                            3000
                        );
                    }
                }
            } catch (error) {
                console.error('Errore checkTimeValidation:', error);
            }
        }

        function getRoomName(roomId) {
            try {
                const room = findRoomById(roomId);
                return room ? room.name : roomId;
            } catch (error) {
                return roomId;
            }
        }

        function highlightMissingFields(roomId, missingFields) {
            try {
                missingFields.forEach(fieldName => {
                    let inputId = '';
                    if (fieldName === 'Data') inputId = `date_${roomId}`;
                    else if (fieldName === 'Ora Inizio') inputId = `startTime_${roomId}`;
                    else if (fieldName === 'Ora Fine') inputId = `endTime_${roomId}`;
                    
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.style.borderColor = '#ef4444';
                        input.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.2)';
                        
                        setTimeout(() => {
                            input.style.borderColor = '#d1d5db';
                            input.style.boxShadow = 'none';
                        }, 3000);
                    }
                });
            } catch (error) {
                console.error('Errore highlightMissingFields:', error);
            }
        }

        function resetRoomForm(roomId) {
            try {
                const dateInput = document.getElementById(`date_${roomId}`);
                const startTimeInput = document.getElementById(`startTime_${roomId}`);
                const endTimeInput = document.getElementById(`endTime_${roomId}`);
                
                if (dateInput) dateInput.value = '';
                if (startTimeInput) startTimeInput.value = '';
                if (endTimeInput) endTimeInput.value = '';
                
                [dateInput, startTimeInput, endTimeInput].forEach(input => {
                    if (input) {
                        input.style.borderColor = '#d1d5db';
                        input.style.boxShadow = 'none';
                    }
                });
                
                validateRoomInputs(roomId);
                
            } catch (error) {
                console.error('Errore resetRoomForm:', error);
            }
        }

        // Rendering UI functions
        function renderRooms() {
            renderFloorRooms('pianoTerra', 'pianoTerraRooms');
            renderFloorRooms('pianoInterrato', 'pianoInterratoRooms');
            renderFloorRooms('palestra', 'palestraRooms');
        }

        function renderFloorRooms(floorKey, containerId) {
            try {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = '';
                
                if (!rooms[floorKey]) return;
                
                rooms[floorKey].forEach(room => {
                    const roomCard = createRoomCard(room);
                    container.appendChild(roomCard);
                });
            } catch (error) {
                console.error('Errore renderFloorRooms:', error);
            }
        }

        // createRoomCard con gestione timeout
        function createRoomCard(room) {
            const card = document.createElement('div');
            card.className = `room-card ${room.status}`;
            card.id = `room_${room.id}`;
            
            const statusText = {
                'on': 'Spento',
                'off': 'Acceso',
                'undefined': 'Non disponibile'
            }[room.status] || 'Sconosciuto';
            
            // Calcola se in timeout
            const now = Date.now();
            const isTimeout = room.lastUpdate && (now - room.lastUpdate) > TIMEOUT_MS;
            const timeoutText = isTimeout ? `(Timeout ${Math.round((now - room.lastUpdate) / 1000)}s)` : '';
            
            // Gestione temperatura per piani specifici
            const hasTemperature = ['pianoInterrato', 'palestra'].some(floor => 
                rooms[floor] && rooms[floor].find(r => r.id === room.id)
            );
            
            card.innerHTML = `
                <div class="room-header">
                    <div class="room-name-status">
                        <div class="room-name">${room.name}</div>
                        <div class="fancoil-status ${room.status}">
                            <span>‚óè</span>
                            <span>${statusText}</span>
                        </div>
                    </div>
                    <button class="schedule-btn-header" onclick="requestWeeklySchedule('${room.id}')">
                        üìÖ Orari Sett.
                    </button>
                </div>
                
                ${isTimeout ? `
                <div class="timeout-indicator">
                    ‚ö†Ô∏è Connessione persa ${timeoutText}
                </div>
                ` : ''}
                
				${hasTemperature && room.temperature !== null && room.status !== 'undefined' ? `
				<div class="temperature-display" ${room.temperature > 3000 ? 'style="background: rgba(239, 68, 68, 0.7);"' : ''}>
				    ${room.temperature > 3000 ? `
			        <span class="temp-unavailable" style="color: white; font-weight: 600;">‚ö†Ô∏è Errore Sonda</span>
				    ` : `
			        <span class="temp-value">${room.temperature.toFixed(1)}</span>
			        <span class="temp-unit">¬∞C</span>
			        <div style="margin-left: auto; font-size: 0.8rem; color: #64748b;">
		            Temp. attuale
		        	</div>
			    	`}
				</div>
                ` : hasTemperature ? `
                <div class="temperature-display">
                    <span class="temp-unavailable">Temperatura non disponibile</span>
                </div>
                ` : ''}
                
                <div class="schedule-controls">
                    <div class="date-time-row">
                        <div class="control-group">
                            <label>üìÖ Data</label>
                            <input type="date" class="control-input" id="date_${room.id}" value="">
                        </div>
                        
                        <div class="control-group">
                            <label>üïê Inizio</label>
                            <select class="control-input time-select" id="startTime_${room.id}">
                                <option value="">-- Sel --</option>
                                ${generateTimeOptions()}
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label>üïê Fine</label>
                            <select class="control-input time-select" id="endTime_${room.id}">
                                <option value="">-- Sel --</option>
                                ${generateTimeOptions()}
                            </select>
                        </div>
                    </div>
                    
                    <div class="action-controls">
                        <div class="control-group">
                            <label>üîÑ Azione</label>
                            <div class="action-selector">
                                <label class="radio-option">
                                    <input type="radio" name="action_${room.id}" value="on" checked>
                                    <span class="radio-label">üü¢ ON</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="action_${room.id}" value="off">
                                    <span class="radio-label">üî¥ OFF</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="sendSchedule('${room.id}')">
                                üì§ Invia
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => setupInputListeners(room.id), 100);
            
            return card;
        }

        // Richiedi orari settimanali
        function requestWeeklySchedule(roomId) {
            if (!MQTT_CONFIG.connected || !MQTT_CONFIG.client) {
                showNotification('‚ùå MQTT non connesso', 'error');
                return;
            }

            try {
                const request = {
                    roomId: roomId,
                    timestamp: Date.now()
                };

                const message = new Paho.MQTT.Message(JSON.stringify(request));
                message.destinationName = TOPICS.WEEKLY_REQUEST;
                message.qos = 0;
                message.retained = false;
                MQTT_CONFIG.client.send(message);

                const room = findRoomById(roomId);
                showNotification(`üì° Richiesta orari per ${room?.name || roomId}...`, 'info', 3000);
                
            } catch (error) {
                console.error('Errore requestWeeklySchedule:', error);
                showNotification('‚ùå Errore richiesta orari', 'error');
            }
        }

        // Utility functions
        function findRoomById(roomId) {
            for (const floor in rooms) {
                const room = rooms[floor].find(r => r.id === roomId);
                if (room) return room;
            }
            return null;
        }

        // updateRoomCard con gestione timeout
        function updateRoomCard(roomId, room) {
            const card = document.getElementById(`room_${roomId}`);
            if (card) {
                card.className = `room-card ${room.status}`;
                
                const statusElement = card.querySelector('.fancoil-status');
                let statusText = {
                    'on': 'Spento',
                    'off': 'Acceso',
                    'undefined': 'Non disponibile'
                }[room.status] || 'Sconosciuto';
                
                if (room.mode && room.mode !== 'undefined') {
                    const modeText = {
                        'manual': 'M',
                        'auto': 'A'
                    }[room.mode] || '';
                    
                    if (modeText) {
                        statusText += ` (${modeText})`;
                    }
                }
                
                statusElement.className = `fancoil-status ${room.status}`;
                statusElement.innerHTML = `<span>‚óè</span><span>${statusText}</span>`;
                
                // Gestione indicatore timeout
                const now = Date.now();
                const isTimeout = room.lastUpdate && (now - room.lastUpdate) > TIMEOUT_MS;
                
                let timeoutIndicator = card.querySelector('.timeout-indicator');
                if (isTimeout) {
                    const timeoutSeconds = Math.round((now - room.lastUpdate) / 1000);
                    if (!timeoutIndicator) {
                        timeoutIndicator = document.createElement('div');
                        timeoutIndicator.className = 'timeout-indicator';
                        const roomHeader = card.querySelector('.room-header');
                        roomHeader.insertAdjacentElement('afterend', timeoutIndicator);
                    }
                    timeoutIndicator.innerHTML = `‚ö†Ô∏è Connessione persa (Timeout ${timeoutSeconds}s)`;
                } else if (timeoutIndicator) {
                    timeoutIndicator.remove();
                }
                
                // Aggiorna temperatura
                const hasTemperature = ['pianoInterrato', 'palestra'].some(floor => 
                    rooms[floor] && rooms[floor].find(r => r.id === roomId)
                );
                
                if (hasTemperature) {
                    let tempContainer = card.querySelector('.temperature-display');
                    
                    if (room.temperature !== null && room.status !== 'undefined') {
                        if (!tempContainer) {
                            const scheduleControls = card.querySelector('.schedule-controls');
                            tempContainer = document.createElement('div');
                            tempContainer.className = 'temperature-display';
                            card.insertBefore(tempContainer, scheduleControls);
                        }
                        
                        // Gestione errore sonda per temperature > 3000
                        if (room.temperature > 3000) {
                            tempContainer.style.background = 'rgba(239, 68, 68, 0.7)';
                            tempContainer.innerHTML = `<span style="color: white; font-weight: 600;">‚ö†Ô∏è Errore Sonda</span>`;
                        } else {
                            tempContainer.style.background = 'rgba(255, 255, 255, 0.5)'; // Reset sfondo normale
                            tempContainer.innerHTML = `
                                <span class="temp-value">${room.temperature.toFixed(1)}</span>
                                <span class="temp-unit">¬∞C</span>
                                <div style="margin-left: auto; font-size: 0.8rem; color: #64748b;">
                                    Temp. attuale
                                </div>
                            `;
                        }
                    } else {
                        if (!tempContainer) {
                            const scheduleControls = card.querySelector('.schedule-controls');
                            tempContainer = document.createElement('div');
                            tempContainer.className = 'temperature-display';
                            card.insertBefore(tempContainer, scheduleControls);
                        }
                        tempContainer.style.background = 'rgba(255, 255, 255, 0.5)'; // Reset sfondo normale
                        tempContainer.innerHTML = `<span class="temp-unavailable">Temperatura non disponibile</span>`;
                    }
                }
            }
        }

        // Aggiorna tutte le card
        function updateAllRoomCards() {
            for (const floor in rooms) {
                rooms[floor].forEach(room => {
                    updateRoomCard(room.id, room);
                });
            }
        }

        // updateStatistics con conteggio timeout
        function updateStatistics() {
            updateFloorStats('pianoTerra', 'pt');
            updateFloorStats('pianoInterrato', 'pi');
            updateFloorStats('palestra', 'pa');
        }

        function updateFloorStats(floorKey, prefix) {
            const floorRooms = rooms[floorKey];
            const total = floorRooms.length;
            const active = floorRooms.filter(room => room.status === 'on').length;
            const timeout = floorRooms.filter(room => room.status === 'undefined').length;
            
            document.getElementById(`${prefix}Total`).textContent = total;
            document.getElementById(`${prefix}Active`).textContent = active;
            
            const timeoutElement = document.getElementById(`${prefix}Timeout`);
            const timeoutCountElement = document.getElementById(`${prefix}TimeoutCount`);
            
            if (timeout > 0) {
                timeoutElement.style.display = 'flex';
                timeoutCountElement.textContent = timeout;
            } else {
                timeoutElement.style.display = 'none';
            }
        }

        function showNotification(message, type = 'info', duration = 4000) {
            try {
                const notification = document.getElementById('notification');
                if (!notification) return;
                
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
            } catch (error) {
                console.error('Errore showNotification:', error);
            }
        }

        // Toggle Console
        function toggleConsole() {
            consoleVisible = !consoleVisible;
            consoleContainer.classList.toggle('show', consoleVisible);
            consoleBtn.classList.toggle('active', consoleVisible);
        }

        // Chiusura modal con click sull'overlay
        document.addEventListener('click', function(event) {
            if (event.target.id === 'rimoDialog') {
                closeRimoInfo();
            }
            if (event.target.id === 'scheduleModal') {
                closeScheduleModal();
            }
        });

        // Chiusura modal con tasto Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeRimoInfo();
                closeScheduleModal();
            }
        });

        // Inizializza dashboard al caricamento
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('üöÄ Caricamento Magalini Medica - Clima...');
                
                consoleBody = document.getElementById('consoleBody');
                consoleContainer = document.getElementById('consoleContainer');
                consoleBtn = document.getElementById('consoleBtn');
                
                if (!consoleBody || !consoleContainer || !consoleBtn) {
                    console.error('Errore: elementi console non trovati nel DOM');
                    return;
                }
                
                console.log('Console elementi trovati:', {
                    body: !!consoleBody,
                    container: !!consoleContainer,
                    btn: !!consoleBtn
                });
                
                consoleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Console button clicked');
                    toggleConsole();
                });
                
                const closeBtn = document.getElementById('consoleClose');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        consoleVisible = false;
                        consoleContainer.classList.remove('show');
                        consoleBtn.classList.remove('active');
                    });
                }
                
                const minimizeBtn = document.getElementById('consoleMinimize');
                if (minimizeBtn) {
                    minimizeBtn.addEventListener('click', function() {
                        consoleVisible = false;
                        consoleContainer.classList.remove('show');
                        consoleBtn.classList.remove('active');
                    });
                }
                
                const clearBtn = document.getElementById('consoleClear');
                if (clearBtn) {
                    clearBtn.addEventListener('click', function() {
                        if (consoleBody) {
                            consoleBody.innerHTML = '';
                            addConsoleLog('info', 'üóëÔ∏è Console pulita');
                        }
                    });
                }
                
                initializeDashboard();
            } catch (error) {
                console.error('Errore critico inizializzazione:', error);
            }
        });

        // Gestione errori globali
        window.addEventListener('error', function(event) {
            console.error('Errore JavaScript:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Promise rejection:', event.reason);
        });
    </script>
</body>
</html>